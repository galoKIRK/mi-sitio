{% extends "base.html" %}
{% load utils %}
{% block title %}Nueva Compra — Carnicería{% endblock %}

{% block content %}
<h2>Nueva Compra</h2>

<form method="post">
  {% csrf_token %}

  <div class="mb-3">
    <label class="form-label">Proveedor</label>
    <select name="proveedor" class="form-select">
      <option value="">-- Sin proveedor --</option>
      {% for p in proveedores %}
      <option value="{{ p.id }}">{{ p.nombre }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light text-center">
        <tr>
          <th>Producto</th>
          <th>Precio unitario</th>
          <th>Stock actual</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
        </tr>
      </thead>

      <tbody>
        {% for producto in productos %}
        <tr>
          <td>{{ producto.nombre }}</td>

          <td>
            <input type="number"
                   step="0.01"
                   min="0"
                   name="precio_{{ producto.id }}"
                   class="form-control precio-input"
                   placeholder="{{ producto.precio }}">
          </td>

          <td class="text-center">
            {{ producto.stock|floatformat:3|format_kilos_gramos }}
          </td>

          <td>
            <input type="number"
                   step="0.001"
                   min="0"
                   name="cantidad_{{ producto.id }}"
                   class="form-control cantidad-input"
                   value="0"
                   data-precio="{{ producto.precio }}">
          </td>

          <td>
            <input type="text"
                   class="form-control subtotal-input"
                   name="subtotal_{{ producto.id }}"
                   value="0.00"
                   readonly>
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <th colspan="4" class="text-end">TOTAL GENERAL:</th>
          <th><input type="text" id="total_general" class="form-control" value="0.00" readonly></th>
        </tr>
      </tfoot>

    </table>
  </div>

  <div class="mt-3">
    <a href="{% url 'compras_historial' %}" class="btn btn-outline-secondary">Volver</a>
    <button type="submit" class="btn btn-primary">Registrar Compra</button>
  </div>

</form>

<script>
document.addEventListener("DOMContentLoaded", function () {

    function recalcularTotales() {
        let totalGeneral = 0;

        document.querySelectorAll("tbody tr").forEach(function (row) {
            let precio = parseFloat(row.querySelector(".precio-input").value) || 0;
            let cantidad = parseFloat(row.querySelector(".cantidad-input").value) || 0;

            let subtotal = precio * cantidad;
            row.querySelector(".subtotal-input").value = subtotal.toFixed(2);

            totalGeneral += subtotal;
        });

        document.getElementById("total_general").value = totalGeneral.toFixed(2);
    }

    document.querySelectorAll(".cantidad-input").forEach(input => {
        input.addEventListener("input", function () {
            let row = this.closest("tr");
            let precioInput = row.querySelector(".precio-input");

            if (parseFloat(this.value) > 0 && (precioInput.value === "" || precioInput.value === "0")) {
                precioInput.value = this.dataset.precio;
            }

            recalcularTotales();
        });
    });

    document.querySelectorAll(".precio-input").forEach(input => {
        input.addEventListener("input", recalcularTotales);
    });

});
</script>

{% endblock %}
