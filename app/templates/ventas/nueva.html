{% extends "base.html" %}
{% load utils %}  <!-- Para mostrar kg + g -->

{% block title %}Nueva venta — Carnicería{% endblock %}

{% block content %}
<h2>Nueva Venta</h2>

<form method="post" class="mt-3">
  {% csrf_token %}

  <!-- Cliente -->
  <div class="mb-3">
    <label class="form-label">Cliente</label>
    <select name="cliente" class="form-select">
      <option value="">-- Sin cliente --</option>
      {% for cliente in clientes %}
      <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-danger">
        <tr>
          <th>Producto</th>
          <th>Precio por kg</th>
          <th>Stock</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
        </tr>
      </thead>

      <tbody>
        {% for producto in productos %}
        <tr data-precio="{{ producto.precio }}">
          <td>{{ producto.nombre }}</td>

          <td>${{ producto.precio }}</td>

          <td>{{ producto.stock|format_kilos_gramos }}</td>

          <td>
            <input 
              type="number"
              step="0.001"
              min="0"
              max="{{ producto.stock }}"
              value="0"
              class="form-control cantidad-input"
              name="prod_{{ producto.id }}"
            >
          </td>

          <td>
            <input 
              type="text"
              class="form-control subtotal-input"
              value="0.00"
              readonly>
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <th colspan="4" class="text-end">TOTAL:</th>
          <th>
            <input type="text" id="total_general" class="form-control" value="0.00" readonly>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'productos' %}" class="btn btn-outline-secondary">Volver</a>
    <button type="submit" class="btn btn-success">Registrar Venta</button>
  </div>

</form>


<!-- ============================= -->
<!-- SCRIPT PARA CALCULAR TOTALES  -->
<!-- ============================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  function recalcularTotales() {
    let totalGeneral = 0;

    document.querySelectorAll("tbody tr").forEach(row => {
      let precio = parseFloat(row.dataset.precio);
      let cantidad = parseFloat(row.querySelector(".cantidad-input").value) || 0;
      let subtotal = precio * cantidad;

      row.querySelector(".subtotal-input").value = subtotal.toFixed(2);
      totalGeneral += subtotal;
    });

    document.getElementById("total_general").value = totalGeneral.toFixed(2);
  }

  document.querySelectorAll(".cantidad-input").forEach(input => {
    input.addEventListener("input", recalcularTotales);
  });

});
</script>

{% endblock %}
